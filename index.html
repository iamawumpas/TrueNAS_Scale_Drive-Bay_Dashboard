<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TrueNAS Drive Bay Assignment</title>
    <style>
        :root {
            --bg-page: #050505;
            --bg-chassis: #1a1a1a;
            --bg-bay: #121212;
            --color-sn: #ffff00;
            --color-size: #ff00ff;
            --color-pool: #ffffff;
            --led-online: #00ff00;
            --led-unused: #8000ff;
            --led-error: #ffaa00;
            --led-activity: #008cff;
            --led-resilver: #ffffff;
            --led-offline: #ff0000;
            --bay-height: 48vh;
            --bay-min-width: 40px;
        }

        body { 
            background: var(--bg-page); color: #eee; font-family: 'Segoe UI', sans-serif; 
            margin: 0; padding: 15px; overflow: hidden; height: 100vh;
            display: flex; flex-direction: column; box-sizing: border-box;
            transition: background 0.5s ease;
        }
        
        .header { flex: 0 0 auto; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px; }

        /* Header logic with inline error message */
        #host-title { 
            transition: opacity 0.5s ease;
            margin: 0;
            display: flex;
            align-items: baseline; /* Aligns text by their bottoms */
            gap: 15px; /* Space between Hostname and Error message */
        }

        @keyframes slowPulse {
            0%   { opacity: 1.0; }
            50%  { opacity: 0.3; }
            100% { opacity: 1.0; }
        }

        #host-title.corrupt { 
            animation: slowPulse 3s ease-in-out infinite;
        }

        /* Inline Sub-text styling */
        #host-title.corrupt::after {
            content: "config file error :: reverting to default settings";
            display: inline; /* Keep on same line */
            font-size: 0.5em; 
            font-weight: normal;
            text-transform: lowercase;
            opacity: 0.7;
        }

        #canvas { flex: 1 1 auto; display: flex; align-items: flex-start; justify-content: center; padding-top: 2vh; }

        .storage-unit { 
            background-color: var(--bg-chassis);
            background-image: 
                repeating-linear-gradient(rgba(255,255,255,0.03) 0px, rgba(255,255,255,0.03) 1px, transparent 1px, transparent 2px),
                linear-gradient(115deg, #111 0%, #222 30%, #333 45%, #222 60%, #111 100%);
            background-size: 100% 2px, 100% 100%;
            border: 1px solid #333; padding: 20px; border-radius: 8px; width: 100%; height: fit-content;
            box-shadow: inset 0 0 20px #000, 0 10px 30px rgba(0,0,0,0.8);
        }

        .unit-header-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
        .unit-header { color: #008cff; font-weight: bold; font-size: 1.2vw; text-transform: uppercase; border-left: 4px solid #008cff; padding-left: 10px; }
        
        .unit-legend { display: flex; gap: 1.2vw; font-size: 0.7vw; color: #aaa; text-transform: uppercase; font-weight: bold; background: rgba(0,0,0,0.4); padding: 6px 12px; border-radius: 4px; border: 1px solid #333; }
        .legend-item { display: flex; align-items: center; gap: 0.4vw; }
        .led-small { width: 0.7vw; height: 0.7vw; border-radius: 50%; border: 1px solid rgba(255,255,255,0.1); }

        .slots { display: flex; gap: 0.5vw; width: 100%; justify-content: space-between; }

        .caddy { 
            background: var(--bg-bay);
            background-image: linear-gradient(90deg, #181818 0%, #2a2a2a 50%, #181818 100%);
            border: 1px solid #333; border-radius: 3px;
            display: flex; flex-direction: column; align-items: center;
            position: relative; flex: 1 1 0; min-width: var(--bay-min-width); height: var(--bay-height);
            padding: 1.5vh 0 0 0; border-top: 4px solid #444; box-sizing: border-box; overflow: hidden;
        }

        .caddy::before {
            content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0; opacity: 0.85;
            background-image: radial-gradient(circle, #000 42%, transparent 45%), radial-gradient(circle, #000 42%, transparent 45%);
            background-size: 18px 18px; background-position: 0 0, 9px 9px; z-index: 1; pointer-events: none;
        }

        .led-group, .bay-id, .info-container, .latch { position: relative; z-index: 5; }

        .led-group { display: flex; justify-content: space-around; width: 100%; padding: 0 10%; margin-bottom: 1.5vh; height: 1.2vw; }
        .caddy .led { 
            width: 1vw; height: 1vw; min-width: 10px; min-height: 10px; border-radius: 50%; 
            background: radial-gradient(circle at 35% 35%, #444 0%, #111 100%);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.8), 0 1px 1px rgba(255,255,255,0.1);
        }

        .caddy .green  { background: radial-gradient(circle at 35% 35%, #bfffbf 0%, var(--led-online) 45%, #004400 100%); box-shadow: 0 0 15px var(--led-online), inset 0 1px 2px #fff; }
        .caddy .purple { background: radial-gradient(circle at 35% 35%, #e0bfff 0%, var(--led-unused) 45%, #220044 100%); box-shadow: 0 0 15px var(--led-unused), inset 0 1px 2px #fff; }
        .caddy .orange { background: radial-gradient(circle at 35% 35%, #ffdfbf 0%, var(--led-error) 45%, #442200 100%); box-shadow: 0 0 15px var(--led-error), inset 0 1px 2px #fff; }
        .caddy .blue   { background: radial-gradient(circle at 35% 35%, #bfe0ff 0%, var(--led-activity) 45%, #002244 100%); box-shadow: 0 0 20px var(--led-activity), inset 0 1px 2px #fff; animation: pulse 0.1s infinite alternate; }
        .caddy .white  { background: radial-gradient(circle at 35% 35%, #ffffff 0%, var(--led-resilver) 45%, #666666 100%); box-shadow: 0 0 15px var(--led-resilver), inset 0 1px 2px #fff; }
        .caddy .red    { background: radial-gradient(circle at 35% 35%, #ffbfbf 0%, var(--led-offline) 45%, #440000 100%); box-shadow: 0 0 15px var(--led-offline), inset 0 1px 2px #fff; }
        
        @keyframes pulse { from { opacity: 1; } to { opacity: 0.6; } }

        .bay-id { font-size: 1.3vw; font-weight: bold; color: #ffaa00; text-align: center; margin-bottom: 2vh; text-shadow: 0 0 5px #000; }
        .info-container { flex-grow: 1; display: flex; align-items: center; justify-content: center; width: 100%; }
        .info { 
            font-size: 1.1vw; font-weight: bold; font-family: 'Courier New', monospace; 
            transform: rotate(-90deg); white-space: nowrap; text-align: center; 
            display: inline-block; width: 40vh; transform-origin: center;
        }

        .latch { width: 100%; height: 6vh; background: #1a1a1a; border-top: 2px solid #333; display: flex; align-items: center; justify-content: center; }
        .latch-button { width: 60%; height: 60%; background: #0c0c0c; border: 1px solid #333; box-shadow: inset 0 2px 5px #000; }
        .status-empty .info { visibility: hidden; } 
    </style>
</head>
<body>
    <div class="header">
        <h2 id="host-title">[ INITIALIZING... ]</h2>
    </div>

    <div id="canvas">
        <div class="storage-unit">
            <div class="unit-header-container">
                <div class="unit-header" id="chassis-name">Storage Array</div>
                <div class="unit-legend" id="legend-box"></div>
            </div>
            <div class="slots" id="slot-container"></div>
        </div>
    </div>

    <script>
        let currentVersion = -1;
        let wasCorrupt = false;

        async function update() {
            try {
                const res = await fetch(`http://${window.location.host}/data`);
                const data = await res.json();
                const cfg = data.config;
                const titleEl = document.getElementById('host-title');

                // Update Hostname and Corruption class
                const hostName = data.hostname ? data.hostname.toUpperCase() : "SERVER";
                titleEl.innerText = `[ ${hostName} ]`;
                
                if (data.corrupt) {
                    titleEl.classList.add('corrupt');
                } else {
                    titleEl.classList.remove('corrupt');
                }

                // Global UI updates
                if (data.version > currentVersion || data.corrupt !== wasCorrupt) {
                    const root = document.documentElement.style;
                    root.setProperty('--bg-page', cfg.colors.page_background);
                    root.setProperty('--bg-chassis', cfg.colors.chassis_background);
                    root.setProperty('--bg-bay', cfg.colors.bay_background);
                    root.setProperty('--color-sn', cfg.colors.text_serial);
                    root.setProperty('--color-size', cfg.colors.text_capacity);
                    root.setProperty('--color-pool', cfg.colors.text_pool);
                    root.setProperty('--led-online', cfg.colors.led_online);
                    root.setProperty('--led-unused', cfg.colors.led_unused);
                    root.setProperty('--led-error', cfg.colors.led_error);
                    root.setProperty('--led-activity', cfg.colors.led_activity);
                    root.setProperty('--led-resilver', cfg.colors.led_resilver);
                    root.setProperty('--led-offline', cfg.colors.led_offline);
                    root.setProperty('--bay-height', cfg.layout.bay_height_vh + 'vh');
                    root.setProperty('--bay-min-width', cfg.layout.bay_width_min_px + 'px');

                    document.getElementById('chassis-name').innerText = cfg.hardware.hba_name;

                    document.getElementById('legend-box').innerHTML = `
                        <div class="legend-item"><div class="led-small" style="background:${cfg.colors.led_online}"></div> ONLINE</div>
                        <div class="legend-item"><div class="led-small" style="background:${cfg.colors.led_resilver}"></div> RESILVER</div>
                        <div class="legend-item"><div class="led-small" style="background:${cfg.colors.led_error}"></div> ERROR</div>
                        <div class="legend-item"><div class="led-small" style="background:${cfg.colors.led_offline}"></div> OFFLINE</div>
                        <div class="legend-item"><div class="led-small" style="background:${cfg.colors.led_unused}"></div> UNUSED</div>
                        <div class="legend-item"><div class="led-small" style="background:${cfg.colors.led_activity}"></div> ACTIVITY</div>
                    `;

                    document.getElementById('slot-container').innerHTML = '';
                    currentVersion = data.version;
                    wasCorrupt = data.corrupt;
                }

                // Disk topology updates
                const slotContainer = document.getElementById('slot-container');
                const pciKey = Object.keys(data.topology)[0];
                const disks = data.topology[pciKey];

                disks.forEach((disk, idx) => {
                    let el = document.getElementById(`disk-${idx}`);
                    if (!el) {
                        el = document.createElement('div');
                        el.id = `disk-${idx}`;
                        el.className = 'caddy';
                        el.innerHTML = `
                            <div class="led-group"><div class="led status-led"></div><div class="led activity-led"></div></div>
                            <div class="bay-id"></div>
                            <div class="info-container"><div class="info"></div></div>
                            <div class="latch"><div class="latch-button"></div></div>
                        `;
                        slotContainer.appendChild(el);
                    }

                    const isPresent = disk.status === 'PRESENT';
                    const infoDiv = el.querySelector('.info');
                    const activityLed = el.querySelector('.activity-led');
                    const statusLed = el.querySelector('.status-led');
                    
                    el.classList.toggle('status-empty', !isPresent);

                    const diskSignature = `${disk.sn}-${disk.size}-${disk.pool}-${isPresent}`;
                    if (el.dataset.signature !== diskSignature) {
                        el.querySelector('.bay-id').innerHTML = `${disk.bay.split(' ')[0]}<br>${disk.bay.split(' ')[1]||''}`;
                        if (isPresent) {
                            infoDiv.innerHTML = `
                                <span style="color: var(--color-sn);">${disk.sn}</span>
                                <span style="color: #666; margin: 0 3px;">|</span>
                                <span style="color: var(--color-size);">${disk.size}</span>
                                <br>
                                <span style="color: var(--color-pool); font-size: 0.85em; opacity: 0.9;">${disk.pool}</span>
                            `;
                        } else {
                            infoDiv.innerHTML = '';
                        }
                        el.dataset.signature = diskSignature;
                    }

                    statusLed.className = `led status-led ${isPresent ? disk.led : ''}`;
                    if (isPresent && disk.active) activityLed.classList.add('blue'); 
                    else activityLed.classList.remove('blue');
                });

            } catch (e) { 
                console.error(e);
                document.getElementById('host-title').classList.add('corrupt');
            }
        }

        update();
        setInterval(update, 100);
    </script>
</body>
</html>